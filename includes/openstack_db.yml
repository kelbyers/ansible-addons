##
# Install packages and do config to setting up the openstack db
---
- name: install openstack database stuff
  yum: enablerepo=updates-testing state=installed name=$item
  tags:
    - openstack_pkgs
    - openstack_db
    - nova
    - glance
  with_items:
    - openstack-nova
    - openstack-glance
    - qpid-cpp-server-daemon

- name: install mysql-server
  yum: pkg=mysql-server
  notify: set mysql password
  tags:
    - openstack_db
    - mysql

- name: ensure mysqld enabled
  service: name=mysqld enabled=yes state=running
  tags:
    - openstack_db
    - mysql
    - openstack_db_init
    - nova
    - glance

- name: configure mysql for openstack nova
  command: /bin/openstack-db --service nova --init --rootpw $rootpw
           -p $novapw --yes
  tags:
    - openstack_db
    - openstack_db_init
    - nova
    - nova_init

- name: configure mysql for openstack glance
  command: /bin/openstack-db --service glance --init --rootpw $rootpw
           -p $glancepw --yes
  tags:
    - openstack_db
    - openstack_db_init
    - glance
    - glance_init

- name: start glance support services
  service: name=$item state=running enabled=yes
  tags:
    - glance
    - glance_services
  with_items:
    - qpidd
    - libvirtd

- name: start glance services
  service: name=openstack-glance-$item state=running enabled=yes
  tags:
    - glance
    - glance_services
  with_items:
    - api
    - registry
